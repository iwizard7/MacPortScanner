name: ğŸš€ Auto Version and Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

env:
  NODE_VERSION: '18'

permissions:
  contents: write
  actions: write

jobs:
  auto-version-and-release:
    name: ğŸš€ Auto Version and Release
    runs-on: macos-14
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ [skip-version]
    if: "!contains(github.event.head_commit.message, '[skip-version]')"
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ–¥ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ” Analyze commit for version bump type
        id: version_type
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Analyzing commit: $COMMIT_MSG"
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñƒ
          if echo "$COMMIT_MSG" | grep -qE "(BREAKING|ğŸ’¥|breaking)"; then
            VERSION_TYPE="major"
            echo "ğŸ”¥ BREAKING CHANGE detected - major version bump"
          elif echo "$COMMIT_MSG" | grep -qE "(feat|âœ¨|feature|add)"; then
            VERSION_TYPE="minor"
            echo "âœ¨ Feature detected - minor version bump"
          elif echo "$COMMIT_MSG" | grep -qE "(fix|ğŸ›|bug|patch)"; then
            VERSION_TYPE="patch"
            echo "ğŸ› Fix detected - patch version bump"
          else
            echo "ğŸ“ No version keywords found - skipping release"
            exit 0
          fi
          
          echo "VERSION_TYPE=$VERSION_TYPE" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '"version"' package.json | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Current version: $CURRENT_VERSION"

      - name: ğŸ”¢ Calculate new version
        id: new_version
        run: |
          CURRENT="${{ steps.current_version.outputs.CURRENT_VERSION }}"
          TYPE="${{ steps.version_type.outputs.VERSION_TYPE }}"
          
          # Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ¸
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
          case $TYPE in
            "major")
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            "minor")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            "patch")
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New version: $CURRENT â†’ $NEW_VERSION"

      - name: âœï¸ Update package.json
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.CURRENT_VERSION }}"
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ package.json
          sed -i "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" package.json
          
          echo "âœ… Updated package.json: $CURRENT_VERSION â†’ $NEW_VERSION"

      - name: ğŸ“š Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          DATE=$(date +"%Y-%m-%d")
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ´Ğ»Ñ CHANGELOG
          if [ -f "CHANGELOG.md" ]; then
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒÑ
            echo "" > /tmp/changelog_entry
            echo "## [$NEW_VERSION] - $DATE" >> /tmp/changelog_entry
            echo "" >> /tmp/changelog_entry
            echo "### ğŸ¤– ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ" >> /tmp/changelog_entry
            echo "- $COMMIT_MSG" >> /tmp/changelog_entry
            echo "" >> /tmp/changelog_entry
            
            # Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² CHANGELOG.md
            awk '
            /^## \[/ && !inserted {
                while ((getline line < "/tmp/changelog_entry") > 0) {
                    print line
                }
                close("/tmp/changelog_entry")
                inserted = 1
            }
            {print}
            ' CHANGELOG.md > /tmp/changelog_new
            mv /tmp/changelog_new CHANGELOG.md
            
            echo "âœ… Updated CHANGELOG.md"
          else
            echo "âš ï¸ CHANGELOG.md not found, skipping"
          fi

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install

      - name: âš›ï¸ Build React application
        run: |
          echo "âš›ï¸ Building React application..."
          npx vite build --outDir build/dist

      - name: ğŸ”¨ Build Electron main process
        run: |
          echo "ğŸ”¨ Compiling TypeScript for Electron..."
          # ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ React build
          mkdir -p build/electron
          npx tsc -p tsconfig.electron.json
          echo "ğŸ“ Checking compiled files..."
          ls -la build/electron/ || echo "build/electron/ folder not found"
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² build/dist
          if [ -f "build/electron/main.js" ]; then
            echo "âœ… main.js found at build/electron/main.js"
            cp build/electron/main.js build/dist/main.js
          else
            echo "âŒ main.js not found, checking structure:"
            find build/electron -name "*.js" -type f
            exit 1
          fi
          
          if [ -f "build/electron/preload.js" ]; then
            echo "âœ… preload.js found at build/electron/preload.js"
            cp build/electron/preload.js build/dist/preload.js
          else
            echo "âŒ preload.js not found, checking structure:"
            find build/electron -name "*.js" -type f
            exit 1
          fi

      - name: ğŸ“ Prepare files for electron-builder
        run: |
          echo "ğŸ“ Preparing files for electron-builder..."
          cp -r build/dist ./dist
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ
          if [ ! -f "dist/main.js" ]; then
            echo "âŒ main.js not found"
            exit 1
          fi
          if [ ! -f "dist/preload.js" ]; then
            echo "âŒ preload.js not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found"
            exit 1
          fi
          echo "âœ… All required files present"

      - name: ğŸ—ï¸ Build macOS applications
        run: |
          echo "ğŸ—ï¸ Building macOS applications with electron-builder..."
          npx electron-builder --mac --publish never
        env:
          # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ CI
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: ğŸ“Š Verify build artifacts
        run: |
          echo "ğŸ“Š Checking build artifacts..."
          if [ -d "build/release" ]; then
            echo "âœ… build/release/ found"
            ls -la build/release/
          else
            echo "âŒ build/release/ not found"
            echo "ğŸ“ Checking all build directories:"
            find . -name "*.dmg" -o -name "*.zip" 2>/dev/null || echo "No DMG/ZIP files found anywhere"
            exit 1
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          echo "ğŸ” Looking for DMG and ZIP files..."
          DMG_COUNT=0
          for file in build/release/*.dmg build/release/*.zip; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "ğŸ“¦ $(basename "$file"): $size"
              DMG_COUNT=$((DMG_COUNT + 1))
            fi
          done
          
          if [ $DMG_COUNT -eq 0 ]; then
            echo "âŒ No DMG or ZIP files found for release!"
            echo "ğŸ“ Contents of build/release/:"
            ls -la build/release/
            exit 1
          else
            echo "âœ… Found $DMG_COUNT release files"
          fi

      - name: ğŸ·ï¸ Create and push tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          git add package.json CHANGELOG.md
          git commit -m "ğŸ¤– chore(release): bump version to $NEW_VERSION [skip-version]"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµĞ³
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          
          # ĞŸÑƒÑˆĞ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸ Ñ‚ĞµĞ³
          git push origin main
          git push origin "v$NEW_VERSION"
          
          echo "âœ… Created and pushed tag v$NEW_VERSION"

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
          echo "ğŸ“ Generating release notes..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ release notes Ğ¸Ğ· CHANGELOG.md ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
          if [ -f "CHANGELOG.md" ]; then
            # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑĞµĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
            RELEASE_NOTES=$(awk "
              /^## \[$NEW_VERSION\]/ { found=1; next }
              /^## \[/ && found { exit }
              found && /^### / { 
                gsub(/^### /, \"**\")
                gsub(/$/, \"**\")
                print
                next
              }
              found && /^- / { print }
              found && /^$/ { print }
            " CHANGELOG.md)
          fi
          
          # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ² CHANGELOG, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
          if [ -z "$RELEASE_NOTES" ]; then
            echo "## MacPortScanner v$NEW_VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "ğŸš€ ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºĞ°Ğ½ĞµÑ€ Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ macOS Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ»Ñ Apple Silicon" >> release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ“¦ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ" >> release_notes.md
            echo "" >> release_notes.md
            echo "- **MacPortScanner-$NEW_VERSION-arm64.dmg** - Ğ”Ğ»Ñ Apple Silicon (M1/M2/M3)" >> release_notes.md
            echo "- **MacPortScanner-$NEW_VERSION.dmg** - Ğ”Ğ»Ñ Intel Mac" >> release_notes.md
            echo "- **ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²Ñ‹** - ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸" >> release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ”§ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" >> release_notes.md
            echo "" >> release_notes.md
            echo "- macOS 10.15 (Catalina) Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²ĞµĞµ" >> release_notes.md
            echo "- Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ: Apple Silicon Ğ´Ğ»Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸" >> release_notes.md
            echo "" >> release_notes.md
            echo "### âš ï¸ ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº" >> release_notes.md
            echo "" >> release_notes.md
            echo "ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ macOS Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸." >> release_notes.md
            echo "**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ©ĞµĞ»ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ â†’ \"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ\" â†’ \"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ\"" >> release_notes.md
          else
            echo "$RELEASE_NOTES" > release_notes.md
          fi
          
          echo "âœ… Release notes generated"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.new_version.outputs.TAG_NAME }}
          name: MacPortScanner ${{ steps.new_version.outputs.TAG_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build/release/*.dmg
            build/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ Summary
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
          echo "ğŸ‰ Version automatically bumped to $NEW_VERSION"
          echo "ğŸ·ï¸ Tag v$NEW_VERSION created and pushed"
          echo "ğŸ“¦ DMG and ZIP files built and uploaded"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v$NEW_VERSION"