name: ğŸš€ Build and Release MacPortScanner

on:
  push:
    tags:
      - 'v*.*.*'  # Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ Ğ½Ğ° Ñ‚ĞµĞ³Ğ¸ Ğ²ĞµÑ€ÑĞ¸Ğ¹ (v1.0.0, v1.2.3, etc.)

env:
  NODE_VERSION: '18'

permissions:
  contents: write
  actions: write

jobs:
  build-and-release:
    name: ğŸ”¨ Build and Release
    runs-on: macos-14
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ changelog

      - name: ğŸ·ï¸ Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION"

      - name: ğŸ–¥ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install

      - name: ğŸ” Verify package.json version
        run: |
          PACKAGE_VERSION=$(grep '"version"' package.json | sed 's/.*"version": "\(.*\)".*/\1/')
          if [ "$PACKAGE_VERSION" != "${{ steps.version.outputs.VERSION }}" ]; then
            echo "âŒ Version mismatch: package.json has $PACKAGE_VERSION, tag is ${{ steps.version.outputs.VERSION }}"
            exit 1
          fi
          echo "âœ… Version verified: $PACKAGE_VERSION"

      - name: âš›ï¸ Build React application
        run: |
          echo "âš›ï¸ Building React application..."
          npx vite build --outDir build/dist

      - name: ğŸ”¨ Build Electron main process
        run: |
          echo "ğŸ”¨ Compiling TypeScript for Electron..."
          # ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ React build
          mkdir -p build/electron
          npx tsc -p tsconfig.electron.json
          echo "ğŸ“ Checking compiled files..."
          ls -la build/electron/ || echo "build/electron/ folder not found"
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² build/dist
          if [ -f "build/electron/main.js" ]; then
            echo "âœ… main.js found at build/electron/main.js"
            cp build/electron/main.js build/dist/main.js
          else
            echo "âŒ main.js not found, checking structure:"
            find build/electron -name "*.js" -type f
            exit 1
          fi
          
          if [ -f "build/electron/preload.js" ]; then
            echo "âœ… preload.js found at build/electron/preload.js"
            cp build/electron/preload.js build/dist/preload.js
          else
            echo "âŒ preload.js not found, checking structure:"
            find build/electron -name "*.js" -type f
            exit 1
          fi

      - name: ğŸ“ Prepare files for electron-builder
        run: |
          echo "ğŸ“ Preparing files for electron-builder..."
          cp -r build/dist ./dist
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ
          if [ ! -f "dist/main.js" ]; then
            echo "âŒ main.js not found"
            exit 1
          fi
          if [ ! -f "dist/preload.js" ]; then
            echo "âŒ preload.js not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found"
            exit 1
          fi
          echo "âœ… All required files present"

      - name: ğŸ—ï¸ Build macOS applications
        run: |
          echo "ğŸ—ï¸ Building macOS applications with electron-builder..."
          npx electron-builder --mac --publish never
        env:
          # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ CI
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: ğŸ“Š Verify build artifacts
        run: |
          echo "ğŸ“Š Checking build artifacts..."
          ls -la build/release/ || echo "âŒ build/release/ not found"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          echo "ğŸ” Looking for DMG and ZIP files..."
          find build/release -name "*.dmg" -o -name "*.zip" | while read file; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "ğŸ“¦ $(basename "$file"): $size"
            fi
          done
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ¸Ğ½ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
          if [ ! -f build/release/*.dmg ] && [ ! -f build/release/*.zip ]; then
            echo "âŒ No DMG or ZIP files found for release!"
            echo "ğŸ“ Contents of build/release/:"
            ls -la build/release/
            exit 1
          fi

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          echo "ğŸ“ Generating release notes..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ release notes Ğ¸Ğ· CHANGELOG.md ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
          if [ -f "CHANGELOG.md" ]; then
            # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑĞµĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
            RELEASE_NOTES=$(awk "
              /^## \[${{ steps.version.outputs.VERSION }}\]/ { found=1; next }
              /^## \[/ && found { exit }
              found && /^### / { 
                gsub(/^### /, \"**\")
                gsub(/$/, \"**\")
                print
                next
              }
              found && /^- / { print }
              found && /^$/ { print }
            " CHANGELOG.md)
          fi
          
          # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ² CHANGELOG, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
          if [ -z "$RELEASE_NOTES" ]; then
            echo "## MacPortScanner ${{ steps.version.outputs.TAG_NAME }}" > release_notes.md
            echo "" >> release_notes.md
            echo "ğŸš€ ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºĞ°Ğ½ĞµÑ€ Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ macOS Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ»Ñ Apple Silicon" >> release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ“¦ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ" >> release_notes.md
            echo "" >> release_notes.md
            echo "- **MacPortScanner-${{ steps.version.outputs.VERSION }}-arm64.dmg** - Ğ”Ğ»Ñ Apple Silicon (M1/M2/M3)" >> release_notes.md
            echo "- **MacPortScanner-${{ steps.version.outputs.VERSION }}.dmg** - Ğ”Ğ»Ñ Intel Mac" >> release_notes.md
            echo "- **ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²Ñ‹** - ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸" >> release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ”§ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" >> release_notes.md
            echo "" >> release_notes.md
            echo "- macOS 10.15 (Catalina) Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²ĞµĞµ" >> release_notes.md
            echo "- Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ: Apple Silicon Ğ´Ğ»Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸" >> release_notes.md
          else
            echo "$RELEASE_NOTES" > release_notes.md
          fi
          
          echo "âœ… Release notes generated"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: MacPortScanner ${{ steps.version.outputs.TAG_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build/release/*.dmg
            build/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Release Summary
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.TAG_NAME }} created successfully!"
          echo ""
          echo "ğŸ“¦ Uploaded files:"
          for file in build/release/*.dmg build/release/*.zip; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "  âœ… $(basename "$file") ($size)"
            fi
          done
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }}"

  # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ job Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  notify:
    name: ğŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success()
    
    steps:
      - name: ğŸ‰ Success Notification
        run: |
          echo "ğŸ‰ MacPortScanner ${{ needs.build-and-release.outputs.TAG_NAME || github.ref_name }} released successfully!"
          echo "ğŸ“¦ DMG and ZIP files uploaded to GitHub Releases"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases"